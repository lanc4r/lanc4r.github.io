<!DOCTYPE html>




<html class="theme-next pisces" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
    
  
  <link href="/css/fancybox.css" rel="stylesheet" type="text/css">




  
  
  
  

  

  

  

  

  

  
    

    
  

  
    
    
    <link href="//fonts.cat.net/css?family=Sigmar One:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="/css/font-awesome.css" rel="stylesheet" type="text/css">



  

<link href="/css/share.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=0.0.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=0.0.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=0.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=0.0.4" color="#222">





  <meta name="keywords" content="长连接,协议相关,WebSocket,">






<link rel="stylesheet" type="text/css" href="/css/csshake.css">
<link rel="stylesheet" type="text/css" href="/css/animated.css">
<link rel="stylesheet" type="text/css" href="/css/APlayer.min.css">




<meta name="description" content="前言最近做了一个扫码登录的功能，它使用到了 WebSocket 建立长连接，因为之前从来没有接触过，所以导致和前端的小哥调了整整一天…… 差点当场去世">
<meta name="keywords" content="长连接,协议相关,WebSocket">
<meta property="og:type" content="article">
<meta property="og:title" content="协议姿势解锁 —— WebSocket长连接">
<meta property="og:url" content="http://yoursite.com/2019/05/11/协议姿势解锁 —— WebSocket 长连接/index.html">
<meta property="og:site_name" content="合缘奇缘，一期一念">
<meta property="og:description" content="前言最近做了一个扫码登录的功能，它使用到了 WebSocket 建立长连接，因为之前从来没有接触过，所以导致和前端的小哥调了整整一天…… 差点当场去世">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocketbg.jpg">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket1.png">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket2.png">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket7.png">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket3.png">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket4.png">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket5.png">
<meta property="og:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket6.png">
<meta property="og:updated_time" content="2019-05-24T15:37:24.252Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="协议姿势解锁 —— WebSocket长连接">
<meta name="twitter:description" content="前言最近做了一个扫码登录的功能，它使用到了 WebSocket 建立长连接，因为之前从来没有接触过，所以导致和前端的小哥调了整整一天…… 差点当场去世">
<meta name="twitter:image" content="https://view.moezx.cc/images/2019/05/11/lanc4r-websocketbg.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '0.0.4',
    sidebar: {"position":"right","display":"always","offset":52,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    since: '5/25/2018 08:30:00',
    onlineAPI: '',
    site: {
      title: '合缘奇缘，一期一念',
      subtitle: '',
      author: 'Lanc4r'
    },
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    leancloud: {
      enable: false,
      appID: '',
      appKey: ''
    },
    favicon: {
      visibilitychange: true,
      narmal: '/images/favicon.ico',
      hidden: '/images/failure.ico',
      show_text: '(/≧▽≦/)咦！又好了！',
      hide_text: '(●—●)喔哟，崩溃啦！'
    }
  };
</script>



  
    <script type="text/javascript" src="/js/jquery.js"></script>


<script type="text/javascript" src="/js/APlayer.min.js"></script>



  <link rel="canonical" href="http://yoursite.com/2019/05/11/协议姿势解锁 —— WebSocket 长连接/">





  <title>协议姿势解锁 —— WebSocket长连接 | 合缘奇缘，一期一念</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-48084758-7', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default" class="theme-darling">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-location-arrow"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-友链">
          <a href="/friends/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-mars"></i> <br>
            
            友链
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-paw"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-听歌">
          <a href="/music/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-music"></i> <br>
            
            听歌
          </a>
        </li>
      

      
      <li class="menu-item search">
          <form class="local-search-form">
            <input name="keyword" type="text" class="local-search-input" id="local-search-input" placeholder="站内搜索">
            <button type="submit" class="local-search-submit"><i class="fa fa-search"></i></button>
          </form>
          <div id="local-search-result" class="local-search-result-cls"></div>
      </li>
    </ul>
  

  
</nav>

<div class="site-brand-wrapper" style="background-image: url('https://view.moezx.cc/images/2019/05/25/lanc4rbg3.jpg')">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <div class="brand">
        <span class="logo-line-before"><i></i></span>
        <div class="site-title">
          <div id="animate" class="animate">
            <span>合</span><span>缘</span><span>奇</span><span>缘</span><span>，</span><span>一</span><span>期</span><span>一</span><span>念</span>
          </div>
          <div id="guide" class="guide">
            <span>合</span><span>缘</span><span>奇</span><span>缘</span><span>，</span><span>一</span><span>期</span><span>一</span><span>念</span>
          </div>
        </div>
        <span class="logo-line-after"><i></i></span>
      </div>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>
<div class="site-master" itemprop="author" itemscope="" itemtype="http://schema.org/Person" style="display: block;">
    <img id="avatar-img" class="site-master-avatar" itemprop="image" src="https://view.moezx.cc/images/2019/05/01/lanc4rbg2.jpg" alt="Lanc4r">
    <h2 class="site-master-description shake" itemprop="description">
        <span style="color:#00a7e0">Write</span> <span style="color:#00a7e0">the</span> <span style="color:#000">Code,</span> <span style="color:#000">Change</span> <span style="color:#ff3f1a">the</span> <span style="color:#ff3f1a">World.</span>
    </h2>
</div>


 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-date">
			<div class="post-month">05月</div>
			<div class="post-day">11</div>
	</div>
  
  <div class="post-badge">
    
      <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
        <a href="/categories/流下了没有技术的泪水/" itemprop="url" rel="index">
          <span itemprop="name">流下了没有技术的泪水</span>
        </a>
      </span>
    
      <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
        <a href="/categories/流下了没有技术的泪水/协议姿势解锁/" itemprop="url" rel="index">
          <span itemprop="name">协议姿势解锁</span>
        </a>
      </span>
    
  </div>
  

  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/11/协议姿势解锁 —— WebSocket 长连接/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lanc4r">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/DIYgod.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="合缘奇缘，一期一念">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">协议姿势解锁 —— WebSocket长连接</h1>
        

        <div class="post-meta">
          <span class="post-time" style="color: #00a7e0;">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-11T17:00:05+08:00">
                2019-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">•</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/流下了没有技术的泪水/" itemprop="url" rel="index">
                    <span itemprop="name" style="color: #ff3f1a;">流下了没有技术的泪水</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/流下了没有技术的泪水/协议姿势解锁/" itemprop="url" rel="index">
                    <span itemprop="name" style="color: #ff3f1a;">协议姿势解锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocketbg.jpg" alt=""></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近做了一个扫码登录的功能，它使用到了 WebSocket 建立长连接，因为之前从来没有接触过，所以导致和前端的小哥调了整整一天…… 差点当场去世</p>
<a id="more"></a>
<p>这里把学到的新姿势记录下来。</p>
<h1 id="自己做的的栗子"><a href="#自己做的的栗子" class="headerlink" title="自己做的的栗子"></a>自己做的的栗子</h1><p>先说一下我做的这个流程，然后再讲讲具体的实现原理。</p>
<p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket1.png" alt=""></p>
<h3 id="1-用户请求后端服务器拿取二维码，这时候后端服务器主要做以下操作："><a href="#1-用户请求后端服务器拿取二维码，这时候后端服务器主要做以下操作：" class="headerlink" title="1. 用户请求后端服务器拿取二维码，这时候后端服务器主要做以下操作："></a>1. 用户请求后端服务器拿取二维码，这时候后端服务器主要做以下操作：</h3><ul>
<li>生成一个 UUID，返回给前端，用于下一步浏览器与 IM 服务器建立连接</li>
<li>同时后端会以 UUID 为键保存时间到缓存中，这个主要是给二维码一个失效时间</li>
<li>二维码内藏一个连接地址(地址带有 UUID)，用户扫描之后进行跳转(其实就是扫描之后手机上有一个 确认登录的按钮啦)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ScanLoginDataDto <span class="title">getScanLoginData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 返回给前端的唯一 UUID，用于每次通信</span></span><br><span class="line">    String uuid = String.valueOf(FBIdWorker.generateUniqueId());</span><br><span class="line">    String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmssSSS"</span>).format(<span class="keyword">new</span> Date());<span class="comment">// 当前时间</span></span><br><span class="line">    redisCacheClient.set(RedisKeys.SCAN_LOGIN_UUID_KEY.key(uuid), time, Const.REDIS_EXPIRE1);</span><br><span class="line">    String sign = DesPlus.getInstance().encrypt(time, AUTH_KEY);</span><br><span class="line">    ScanLoginDataDto scanLoginData = <span class="keyword">new</span> ScanLoginDataDto();</span><br><span class="line">    scanLoginData.setSign(sign);</span><br><span class="line">    scanLoginData.setTime(time);</span><br><span class="line">    scanLoginData.setUuid(uuid);</span><br><span class="line">    <span class="keyword">return</span> scanLoginData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createQrCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> BizException </span>&#123;</span><br><span class="line">    ScanLoginDataDto scanLoginData = FBClientHelper.getLoginservice().getScanLoginData();</span><br><span class="line">    monitorLog.log(<span class="string">"sign="</span> + scanLoginData.getSign());</span><br><span class="line">    monitorLog.log(<span class="string">"uuid="</span> + scanLoginData.getUuid());</span><br><span class="line">    CookieUtils.addCookie(response, LoginBizImpl.USER_ID, scanLoginData.getUuid(), LoginBizImpl.COOKIE_EXPIRE,</span><br><span class="line">            LoginBizImpl.DOMAIN);</span><br><span class="line">    createQRCode(response, scanLoginData.getSign(), scanLoginData.getUuid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-前端使用第一步拿到的-uuid-与IM服务器建立-WebSocket-连接，以后每当-IM-服务器收到推送就会主动发给前端，如下图"><a href="#2-前端使用第一步拿到的-uuid-与IM服务器建立-WebSocket-连接，以后每当-IM-服务器收到推送就会主动发给前端，如下图" class="headerlink" title="2. 前端使用第一步拿到的 uuid 与IM服务器建立 WebSocket 连接，以后每当 IM 服务器收到推送就会主动发给前端，如下图"></a>2. 前端使用第一步拿到的 uuid 与IM服务器建立 WebSocket 连接，以后每当 IM 服务器收到推送就会主动发给前端，如下图</h3><p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket2.png" alt=""></p>
<h3 id="3、4：用户扫描二维码，解码得到藏在二维码中的连接并进行访问"><a href="#3、4：用户扫描二维码，解码得到藏在二维码中的连接并进行访问" class="headerlink" title="3、4：用户扫描二维码，解码得到藏在二维码中的连接并进行访问"></a>3、4：用户扫描二维码，解码得到藏在二维码中的连接并进行访问</h3><ul>
<li>后端验证数据是否正常、二维码是否过期等问题</li>
<li>验证通过后，后端向 IM 服务器发送推送(此时使用的唯一标识就是第一步生成的 UUID)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAuthUUID</span><span class="params">(String sign, String uuid)</span> <span class="keyword">throws</span> BizException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isBlank(sign) || StringUtil.isBlank(uuid)) &#123;<span class="comment">// 参数为空返回false</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(SystemEnum.VALIDATE);</span><br><span class="line">        &#125;</span><br><span class="line">        String time = decrypt(sign, LoginServiceImpl.AUTH_KEY);</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isBlank(time)) &#123;<span class="comment">// 解密失败,返回false</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(SystemEnum.VALIDATE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有找到uuid,过期了或者传递的uuid参数不正确</span></span><br><span class="line">        String cacheTime = (String) redisCacheClient.get(RedisKeys.SCAN_LOGIN_UUID_KEY.key(uuid));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(cacheTime) || !cacheTime.equals(time)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">"当前二维码已过期，请刷新页面重试！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 推送消息，二维码扫描成功</span></span><br><span class="line">        IMCometDto dto = <span class="keyword">new</span> IMCometDto();</span><br><span class="line">        dto.setFlag(<span class="number">1</span>);</span><br><span class="line">        dto.setMsg(<span class="string">"true"</span>);</span><br><span class="line">        monitorLog.log(<span class="string">"发送消息到comet平台...sign="</span> + sign + <span class="string">"uuid="</span> + uuid + <span class="string">",result=true"</span>);</span><br><span class="line">        <span class="keyword">long</span> tempUserId = Long.parseLong(uuid);</span><br><span class="line">        <span class="keyword">this</span>.pushRealtimeForUnlogin(tempUserId, dto);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        catalinaLog.error(<span class="string">"校验UUID失败"</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-IM-向浏览器发送推送消息，这里其实就是告诉浏览器：嘿，用户已经扫码啦，你看你要不要做点什么。"><a href="#5-IM-向浏览器发送推送消息，这里其实就是告诉浏览器：嘿，用户已经扫码啦，你看你要不要做点什么。" class="headerlink" title="5. IM 向浏览器发送推送消息，这里其实就是告诉浏览器：嘿，用户已经扫码啦，你看你要不要做点什么。"></a>5. IM 向浏览器发送推送消息，这里其实就是告诉浏览器：嘿，用户已经扫码啦，你看你要不要做点什么。</h3><ul>
<li>比如：换一张图片，就像通常的扫码登录一样，提示用户点击手机上的确认登录啥啥啥的。</li>
</ul>
<p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket7.png" alt=""></p>
<h3 id="6、7-用户手机上点击确认登录，请求发送到后端服务器后会做以下操作："><a href="#6、7-用户手机上点击确认登录，请求发送到后端服务器后会做以下操作：" class="headerlink" title="6、7. 用户手机上点击确认登录，请求发送到后端服务器后会做以下操作："></a>6、7. 用户手机上点击确认登录，请求发送到后端服务器后会做以下操作：</h3><ul>
<li>处于安全考虑，再次验证用户的数据是否正确(主要是防止恶意用户直接调用接口操作)</li>
<li>生成一个加密后的认证key，将其传递发送给 IM服务器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanLogin</span><span class="params">(String sign, String uuid, Long userId)</span> <span class="keyword">throws</span> BizException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isBlank(sign) || StringUtil.isBlank(uuid) || FbNumberUtils.isInvalid(userId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BizException(SystemEnum.INVALID);</span><br><span class="line">    &#125;</span><br><span class="line">    String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmssSSS"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">    String sign1 = encrypt(userId.toString(), time + LoginServiceImpl.AUTH_KEY);</span><br><span class="line">    String sign2 = encrypt(time, LoginServiceImpl.AUTH_KEY);</span><br><span class="line">    String sign3 = encrypt(uuid, LoginServiceImpl.AUTH_KEY);</span><br><span class="line">    String authKey = sign1 + <span class="string">","</span> + sign2 + <span class="string">","</span> + sign3;</span><br><span class="line">    redisCacheClient.set(RedisKeys.SCAN_LOGIN_AUTH_KEY.key(userId), authKey, Const.REDIS_EXPIRE1);</span><br><span class="line">    IMCometDto dto = <span class="keyword">new</span> IMCometDto();</span><br><span class="line">    dto.setFlag(<span class="number">2</span>);</span><br><span class="line">    dto.setMsg(<span class="string">"true"</span>);</span><br><span class="line">    dto.setData(authKey);</span><br><span class="line">    <span class="keyword">long</span> tempUserId = Long.parseLong(uuid);</span><br><span class="line">    <span class="keyword">this</span>.pushRealtimeForUnlogin(tempUserId, dto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8、IM-发送推送，将上一步获得的-认证key-交给前端，前端使用此key继续与后端进行登录的操作"><a href="#8、IM-发送推送，将上一步获得的-认证key-交给前端，前端使用此key继续与后端进行登录的操作" class="headerlink" title="8、IM 发送推送，将上一步获得的 认证key 交给前端，前端使用此key继续与后端进行登录的操作"></a>8、IM 发送推送，将上一步获得的 认证key 交给前端，前端使用此key继续与后端进行登录的操作</h3><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ok，以上就是一次简单的扫码登录过程，至于第八步后，前端如何利用得到的 认证key 进行登录这里就不讨论啦，具体按业务的场景来实现咯。</p>
<p>接下来我们具体聊聊这个长连接是啥，这个 WebSocket 又是个啥。</p>
<h1 id="长连接"><a href="#长连接" class="headerlink" title="长连接"></a>长连接</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><strong>长连接这一概念其实是出自于传输层协议(TCP、UDP)</strong>，长连接表示的是 <strong>TCP 长连接</strong>。它是指<strong>建立一次连接之后，不中断，后续能够持续传递数据</strong>，直到客户端与服务端主动断开为止。</p>
<p>只有通过 TCP 协议传输才能使用长连接，毕竟 UDP 是不建立连接的嘛(关于网络数据的相关知识这里挖一个坑，之后专门找个时间聊聊)。</p>
<h2 id="HTTP-长连接"><a href="#HTTP-长连接" class="headerlink" title="HTTP 长连接"></a>HTTP 长连接</h2><p>HTTP 协议属于应用层的协议，<strong>所谓的 HTTP长连接，其实质还是还是 TCP 的长连接</strong>。</p>
<h3 id="1-0-和-1-1-的区别"><a href="#1-0-和-1-1-的区别" class="headerlink" title="1.0 和 1.1 的区别"></a>1.0 和 1.1 的区别</h3><p><strong>在 HTTP 1.0 中，默认使用的是短连接</strong>，其本质是：<strong>建立 TCP 连接的时候使用的是短连接的方式。</strong><br>浏览器和服务器每进行一次HTTP操作，就建立一次 TCP 连接，但任务结束就中断连接。如果客户端浏览器访问的某个HTML或其他类型的 Web页中包含有其他的Web资源，如JavaScript文件、图像文件、CSS文件等；当浏览器每遇到这样一个Web资源，就会建立一个HTTP会话。</p>
<p><strong>在 HTTP1.1 中，默认使用的是长连接</strong>，同理，<strong>其建立的 TCP 连接使用的是长连接的形式。</strong><br>长连接默认会在响应头中加入：<code>Connection: keep-alive</code>。<br>在使用长连接的情况下，当一个网页打开完成后，<strong>客户端和服务器之间用于传输HTTP数据的 TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接</strong>。<code>Keep-Alive</code> 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接要客户端和服务端都支持长连接。</p>
<h2 id="TCP-的长连接、短连接"><a href="#TCP-的长连接、短连接" class="headerlink" title="TCP 的长连接、短连接"></a>TCP 的长连接、短连接</h2><h3 id="TCP-短连接"><a href="#TCP-短连接" class="headerlink" title="TCP 短连接"></a>TCP 短连接</h3><p>client向server发起连接请求，server接到请求，然后双方建立连接。client向server 发送消息，server回应client，然后一次读写就完成了，这时候双方任何一个都可以发起close操作，不过一般都是client先发起 close操作。为什么呢，一般的server不会回复完client后立即关闭连接的，当然不排除有特殊的情况。从上面的描述看，短连接一般只会在 client/server间传递一次读写操作</p>
<h3 id="TCP-长连接"><a href="#TCP-长连接" class="headerlink" title="TCP 长连接"></a>TCP 长连接</h3><p>client向server发起连接，server接受client连接，双方建立连接。Client与server完成一次读写之后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接。</p>
<h3 id="利弊分析"><a href="#利弊分析" class="headerlink" title="利弊分析"></a>利弊分析</h3><h4 id="长连接的优缺点"><a href="#长连接的优缺点" class="headerlink" title="长连接的优缺点"></a>长连接的优缺点</h4><ul>
<li><strong>优点</strong>：长连接可以<strong>省去较多的TCP建立和关闭的操作，减少浪费，节约时间</strong>。我们知道 TCP 建立连接的时候会有经典的 <strong>三次握手</strong>，同时释放也有 <strong>四次挥手</strong>(挖坑挖坑)。简单说来就是每个连接的建立和释放都是需要消耗时间的的。</li>
<li><strong>缺点</strong>：由于长连接会一直保持着与客户端的连接，每一个连接都会消耗掉服务器的资源。所以当用户数量越来越多的时候，此时建立的长连接数目就会日益增多，服务器的资源也会逐渐被消耗殆尽。</li>
</ul>
<p><strong>标记</strong>：服务端可以采用一些策略来避免长连接数目过多导致资源无法释放的问题。例如：关闭一些长时间没有读写事件发生的连接，或是可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个恶意的客户端连累后端服务。</p>
<h4 id="短连接的优缺点"><a href="#短连接的优缺点" class="headerlink" title="短连接的优缺点"></a>短连接的优缺点</h4><ul>
<li><strong>优点</strong>：管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。一次连接之后就断开，资源能够迅速释放。</li>
<li><strong>缺点</strong>： 如果客户<strong>请求频繁</strong>，将在<strong>TCP的建立和关闭操作上浪费时间和带宽</strong>。</li>
</ul>
<h3 id="什么时候该用长连接或是短连接"><a href="#什么时候该用长连接或是短连接" class="headerlink" title="什么时候该用长连接或是短连接"></a>什么时候该用长连接或是短连接</h3><p><strong>长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况</strong>。每个TCP连接都需要三步握手，这需要时间，如果每个操作都是先连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开，下次处理时直接发送数据包就OK了，不用建立TCP连接。例如：数据库的连接用长连接， 如果用短连接频繁的通信会造成socket错误，而且频繁的socket 创建也是对资源的浪费。 </p>
<p>短连接则就适用于<strong>请求量不多，并且不需要快速响应、不需要考虑连接数目的情况</strong>。举个极端的栗子：一个站点只有一些纯静态页面，在第一次访问的时候，连接就可以断开了，因为不需要再次加载其他的数据了，这时候连接就可以关闭了，所以短连接就是比较好的选择。<br>还有连接数目较多的情况，如果每一个用户都占据一个长连接，这时候服务器会吃不消的。所以在高并发的情况下，短连接可能会优于长连接，毕竟资源能够得到及时释放。<br>再比如我们的网游就不适合短连接，因为用户每一次的操作服务端都需要立即响应，如果使用短连接的话，每一次操作都需要进行三次握手建立连接，这样估计所有人都变成 高ping战士了吧。</p>
<h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><p>首先和之前一样，什么是 Socket 这里不聊，先挖个坑，等到后面学网络相关知识的时候再说说(其实最关键的就是现在我不不懂，逃~)，直接看看 WebSocket，以下内容来自Wikipedia：</p>
<blockquote>
<p>WebSocket是一种通信协议，可在单个TCP连接上进行全双工通信。WebSocket协议在2011年由IETF标准化为RFC 6455，后由RFC 7936补充规范。Web IDL中的WebSocket API由W3C标准化。<br>WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输。</p>
<p>与HTTP不同，WebSocket提供全双工通信。[2][3]此外，WebSocket还可以在TCP之上启用消息流。TCP单独处理字节流，没有固有的消息概念。 在WebSocket之前，使用Comet可以实现全双工通信。但是Comet存在TCP握手和HTTP头的开销，因此对于小消息来说效率很低。WebSocket协议旨在解决这些问题。<br>WebSocket协议规范将ws（WebSocket）和wss（WebSocket Secure）定义为两个新的统一资源标识符（URI）方案[4]，分别对应明文和加密连接。除了方案名称和片段ID（不支持#）之外，其余的URI组件都被定义为此URI的通用语法。</p>
</blockquote>
<p><strong>画个图简单了解一下：</strong></p>
<p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket3.png" alt=""></p>
<p>注意图中这个<strong><big>主动</big></strong>二字，它<strong>允许服务器主动发消息给客户端</strong>，这个特性就是它与 HTTP长连接 最关键的区别，这个区别我们待会再讲。</p>
<h2 id="先看一个栗子"><a href="#先看一个栗子" class="headerlink" title="先看一个栗子"></a>先看一个栗子</h2><p>这里以我之前做的那个扫码登录为例，我们看一下一次建立连接的请求和相应：</p>
<p>以下内容来自知乎上的高票回答：<a href="https://www.zhihu.com/question/20215561/answer/40316953" target="_blank" rel="noopener">WebSocket 是什么原理？为什么可以实现持久连接？</a></p>
<h3 id="Request-Header"><a href="#Request-Header" class="headerlink" title="Request Header"></a>Request Header</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">wss://xxx.com/biubiubiu</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: xxx.com</span><br><span class="line"><span class="attribute">Connection</span>: Upgrade</span><br><span class="line"><span class="attribute">Upgrade</span>: websocket</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"><span class="attribute">Origin</span>: https://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span>: 13</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span>: xYYxw93s9lgPJamgzhQYSA==</span><br><span class="line"><span class="attribute">Sec-WebSocket-Extensions</span>: permessage-deflate; client_max_window_bits</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span>: biubiubiu</span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Connection</span>: Upgrade</span><br><span class="line"><span class="attribute">Upgrade</span>: websocket</span><br></pre></td></tr></table></figure>
<p>这两个字段表示告诉服务器：<strong>用户发起的请求是 WebSocket 请求，请建立相应的 WebSocket 的连接</strong>。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Sec-WebSocket-Key</span>: xYYxw93s9lgPJamgzhQYSA==</span><br><span class="line"><span class="attribute">Sec-WebSocket-Extensions</span>: permessage-deflate; client_max_window_bits</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span>: biubiubiu</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span>: 13</span><br></pre></td></tr></table></figure>
<p><strong>WebSocket-Key</strong> 是浏览器随机生成的key，用于之后客户端验证服务端的响应。<br><strong>WebSocket-Protocol</strong> 就是一个用户定义的字符串，用来区分同URL下，不同的服务所需要的协议。简单理解：今晚我要服务A，别搞错啦~<br><strong>WebSocket-Version</strong> 是告诉服务器所使用的Websocket Draft（协议版本），在最初的时候，Websocket协议还在 Draft 阶段，各种奇奇怪怪的协议都有，而且还有很多期奇奇怪怪不同的东西，什么Firefox和Chrome用的不是一个版本之类的，当初Websocket协议太多可是一个大难题。。不过现在还好，已经定下来啦~大家都使用的一个东西。</p>
<h3 id="Response-Header"><a href="#Response-Header" class="headerlink" title="Response Header"></a>Response Header</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">upgrade</span>: websocket</span><br><span class="line"><span class="attribute">connection</span>: upgrade</span><br><span class="line"><span class="attribute">sec-websocket-accept</span>: rr1pYt5f4uiHqjGqjRdq+UMK5s4=</span><br><span class="line"><span class="attribute">sec-websocket-protocol</span>: biubiubiu</span><br></pre></td></tr></table></figure>
<p><strong>HTTP/1.1 101 Switching Protocols</strong> 表示同意客户端协议转换请求，并将它转换为<strong>websocket</strong>协议。<br><strong><big>websocket-accept</big></strong> 这个则是经过服务器确认，并且加密过后的 <strong>Sec-WebSocket-Key</strong>。浏览器需要根据请求头中的 <strong>Sec-WebSocket-Key</strong> 来判断这次相应是否是自己发送请求的响应，简单说就是验证有没有人冒充服务器响应，从而避免与未知的服务器建立了连接。<br><strong><big>websocket-protocol</big></strong> 表示使用的协议，和之前请求头中的一样。</p>
<p>你可能会发现一个问题：<strong>噫，咱们不是说好的使用 WebSocket 协议吗，为什么请求头和响应头中还存在了 HTTP/1.1 关键字呢，难道这次请求发的是 HTTP 请求，数据都使用 HTTP 请求来发送？？？</strong></p>
<p>在回答上述问题之前我们需要先说说 WebSocket 和 HTTP 的关系</p>
<h2 id="WebSocket-和-HTTP-的关系"><a href="#WebSocket-和-HTTP-的关系" class="headerlink" title="WebSocket 和 HTTP 的关系"></a>WebSocket 和 HTTP 的关系</h2><p>首先 <strong>WebSocket 和 HTTP 协议一样，都是处于应用层的协议，它们都需要通过 TCP协议进行数据的传输</strong>。简单说就是 <strong>WebSocket 和 HTTP 是同一级的，基本没什么关系</strong>……</p>
<p>值得一提的是，WebSocket 是一种<strong>持久化</strong>的协议，而 HTTP 是一种非持久化的协议。</p>
<p>简单的理解就是：HTTP的生命周期是通过Request来界定，也就是一个Request 一个Response，那么在HTTP1.0中，这次HTTP请求就结束了。<strong>在HTTP1.1中进行了改进，使得有一个keep-alive，也就是说，在一个HTTP连接中，可以发送多个Request，接收多个Response</strong>。<br>但是请记住 Request = Response ， 在HTTP中永远是这样，也就是说<strong>一个request只能有一个response</strong>。而且这个response也是被动的，不能主动发起。</p>
<h3 id="HL-瞎BB"><a href="#HL-瞎BB" class="headerlink" title="HL 瞎BB"></a>HL 瞎BB</h3><p>其实关于 HTTP 是一种非持久的协议我觉得还有一种解释就是 <strong>HTTP 协议是无状态的,它对于事务处理是没有记忆能力的</strong>。简单说就是一次请求结束后(一个 request 和 response)，服务器就忘记了：诶，刚才是谁发的消息来着？ 这就导致服务器是不会主动推送消息给客户端，它必须等到客户端再次发来请求之后，才知道：奥，原理是你发的消息啊，来来来，这是你要的数据请收好。接着 response 返回，服务器：诶？我刚才把数据给谁了来着？…….<br>这也能解释上面所说的 response 只能是被动的，不能主动发起，因为服务器根本不知道给谁啊…..</p>
<p>而 WebSocket 就不同，它会<strong>让服务器记住上次来的人是谁，从而只要有了新的消息就可以主动推送出去，而不必等到下一次客户端的请求到来才推送出去</strong>。</p>
<h2 id="WebSocket-借助-HTTP-请求来建立连接"><a href="#WebSocket-借助-HTTP-请求来建立连接" class="headerlink" title="WebSocket 借助 HTTP 请求来建立连接"></a>WebSocket 借助 HTTP 请求来建立连接</h2><p>前面抓包发现，在建立 WebSocket 连接的时候发送了 HTTP 请求，这其实是因为：<strong>WebSocket 使用了 HTTP 协议来完成与客户端的连接</strong>，当连接建立完成之后，后面的事情就和 HTTP 没有没有什么关系了，数据的传输的全部走 WebSocket 协议，不再通过 HTTP 来完成，你可以抓个包在 Message 一栏下观察传输的数据，like this：</p>
<p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket4.png" alt=""></p>
<h2 id="类似WebSocket-的及时通讯技术"><a href="#类似WebSocket-的及时通讯技术" class="headerlink" title="类似WebSocket 的及时通讯技术"></a>类似WebSocket 的及时通讯技术</h2><p>其实在 WebSocket 技术出现之前，也存在与其他的方法来实现即时通讯，其中我们最常听到的就是：<strong>前端轮询</strong> 和 <strong>Comet 技术</strong>。下面简单聊聊这两个技术吧。</p>
<h3 id="前端轮询"><a href="#前端轮询" class="headerlink" title="前端轮询"></a>前端轮询</h3><p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket5.png" alt=""></p>
<p>简单说就是前端一次次的问服务端，有没有新的数据啊，<strong>服务器端每次都会做出响应</strong>，前端根据服务端的相应来进行下一步的决策，到底是否还需要继续请求获取数据。请注意，这里<strong>服务端针对于前端每次的请求都会做出响应，不管有没有生成数据</strong>！</p>
<h3 id="Comet-技术"><a href="#Comet-技术" class="headerlink" title="Comet 技术"></a>Comet 技术</h3><p><img src="https://view.moezx.cc/images/2019/05/11/lanc4r-websocket6.png" alt=""></p>
<p>Comet 技术又叫做 http long pool，它与轮询的本质区别就是在没有生成数据之前服务端不会给客户端响应，而是<strong>把这个链接“握住”</strong>，当数据生成完毕之后再做出响应。</p>
<h2 id="三种方式的比较"><a href="#三种方式的比较" class="headerlink" title="三种方式的比较"></a>三种方式的比较</h2><h3 id="主动性"><a href="#主动性" class="headerlink" title="主动性"></a>主动性</h3><p><strong>WebSocket 技术相对于其它两种技术来说是具有主动性的，它可以主动发送推送消息给客户端</strong>。而其它两种只有当一次请求来之后才能返回数据，它不能主动推送消息给客户端。这一点前面解释过啦，HTTP 协议是一种无状态的协议。</p>
<h3 id="实时性"><a href="#实时性" class="headerlink" title="实时性"></a>实时性</h3><p>WebSocket 和 Comet 都是只要当数据生成完毕立马返回给客户端，可以说是实时性比较高。而轮询的情况，如果服务端生成数据之后需要等到下一次轮询来的时候才能返回，不能第一时间获取到最新的数据</p>
<h3 id="优劣比较"><a href="#优劣比较" class="headerlink" title="优劣比较"></a>优劣比较</h3><p>轮询的实时性速度相对于其它两种方法来说会慢一点，但它不需要服务服务器端保留和客户端的连接，这一优点可能在用户数量特别的情况下会比较好地体现出来。<br>Comet 技术实时性高于轮询技术，但是它会让客户端保留当前连接的资源，也就是说服务端会“握住”这次请求，直到生成结果之后才返回。<br>WebSocket 技术，实时性高于轮询，同时服务端也需要保留与客户端的连接。但是 WebSocket 能够主动的推送消息到客户端，<strong>避免 HTTP 建立连接所花费的时间</strong>。</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol>
<li>WebSocket是一种应用层的协议，它使用了 HTTP 协议来完成与客户端的连接。</li>
<li>WebSocket 是持久化的协议，能够主动推送消息到客户端，解决了由于无状态的HTTP协议被动的缺陷。</li>
<li>类似 WebSocket 的实时通信技术还有 轮询技术 和 Comet 技术，它们各有优劣，具体需要按业务情况进行选择。</li>
</ol>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p><a href="http://www.cnblogs.com/0201zcr/p/4694945.html" target="_blank" rel="noopener">HTTP长连接和短连接</a><br><a href="https://segmentfault.com/a/1190000015122195" target="_blank" rel="noopener">WebSocket与http长连接的区别</a><br><a href="https://www.zhihu.com/question/20215561" target="_blank" rel="noopener">WebSocket 是什么原理？为什么可以实现持久连接？</a></p>
<h1 id="随笔"><a href="#随笔" class="headerlink" title="随笔"></a>随笔</h1><p>最近生活出现了一些变动……</p>
<p>前些时间跟赞哥聊了会，给了我另一个角度来思考问题。他给我分析了一下公有制为主题经济制度下的中国，大概只有进入体制内的经济才是最稳的，毕竟国家不会饿死自己人。<br>最近的泡沫经济开始瓦解，资本主义家们为了生存下来势必会压缩成本，于是裁员肯定是免不了的决策。如果我不能在10年成为一个资本企业中不可或缺的力量，那么必然就会被淘汰，一定会有新生力量来代替你，因为他们的成本比你低啊！最典型的就是强东哥对他的兄弟下手啦，资本主义家的总是在衡量你的价值！并且还得趁自己还有竞争力，早点进入到体制经济中，不然等到人老珠黄，再想转估计就难了。</p>
<p>先姑且不讨论赞哥说的对不对，至少带给我了一个新的角度来权衡自己的未来发展战略。</p>
<p>最近发生的事情让我突然想到大学里一个同学常常挂在嘴边的那句话：“This is life”。</p>
<p>对啊，这才是生活该有的样子，从来不会给你时间准备好的。就像《这个杀手不太冷》中 玛蒂尔达 与 莱昂的对话：</p>
<blockquote>
<p>Is life always this hard. Or is it just when you’re a kid?</p>
</blockquote>
<blockquote>
<p>Always like this.</p>
</blockquote>
<p>是的，总是如此。</p>

      
    </div>
    
    
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/长连接/" rel="tag"># 长连接</a>
          
            <a href="/tags/协议相关/" rel="tag"># 协议相关</a>
          
            <a href="/tags/WebSocket/" rel="tag"># WebSocket</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/07/弱鸡HL对源码的正确打开方式 —— Mybatis 总结篇/" rel="next" title="弱鸡HL对源码的正确打开方式 —— Mybatis总结篇">
                <i class="fa fa-chevron-left"></i> 弱鸡HL对源码的正确打开方式 —— Mybatis总结篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/12/从入门到迷路系列——心理学学习笔记(三)/" rel="prev" title="从入门到迷路系列 —— 心理学学习笔记(斯金纳)">
                从入门到迷路系列 —— 心理学学习笔记(斯金纳) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNjkxNy8xMzQ1Mw=="></div>
    </div>

  





  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  













        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element shake-hard" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://view.moezx.cc/images/2019/05/01/lanc4rbg1.jpg" alt="Lanc4r">
            
              <p class="site-author-name" itemprop="name"><span style="opacity:.2;">咸鱼</span>Lanc4r</p>
              <p class="site-description motion-element" itemprop="description">你看见我的甜甜圈了么？</p>
          </div>

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/lanc4r" target="_blank" title="GitHub" data-balloon="GitHub" data-balloon-pos="up">
                    
                      <i class="fa fa-fw fa-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://github.com/lanc4r" target="_blank" title="微博" data-balloon="微博" data-balloon-pos="up">
                    
                      <i class="fa fa-fw fa-weibo"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="/images/qq-g.jpg" target="_blank" title="QQ" data-balloon="QQ" data-balloon-pos="up">
                    
                      <i class="fa fa-fw fa-qq"></i></a>
                </span>
              
            
          </div>

          

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">51</span>
                  <span class="site-state-item-name" style="color: #00a7e0" ;="">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name" style="color: #ff3f1a;">分类</span>
                </a>
              </div>
            
            

          </nav>

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自己做的的栗子"><span class="nav-number">2.</span> <span class="nav-text">自己做的的栗子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-用户请求后端服务器拿取二维码，这时候后端服务器主要做以下操作："><span class="nav-number">2.0.1.</span> <span class="nav-text">1. 用户请求后端服务器拿取二维码，这时候后端服务器主要做以下操作：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-前端使用第一步拿到的-uuid-与IM服务器建立-WebSocket-连接，以后每当-IM-服务器收到推送就会主动发给前端，如下图"><span class="nav-number">2.0.2.</span> <span class="nav-text">2. 前端使用第一步拿到的 uuid 与IM服务器建立 WebSocket 连接，以后每当 IM 服务器收到推送就会主动发给前端，如下图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、4：用户扫描二维码，解码得到藏在二维码中的连接并进行访问"><span class="nav-number">2.0.3.</span> <span class="nav-text">3、4：用户扫描二维码，解码得到藏在二维码中的连接并进行访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-IM-向浏览器发送推送消息，这里其实就是告诉浏览器：嘿，用户已经扫码啦，你看你要不要做点什么。"><span class="nav-number">2.0.4.</span> <span class="nav-text">5. IM 向浏览器发送推送消息，这里其实就是告诉浏览器：嘿，用户已经扫码啦，你看你要不要做点什么。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6、7-用户手机上点击确认登录，请求发送到后端服务器后会做以下操作："><span class="nav-number">2.0.5.</span> <span class="nav-text">6、7. 用户手机上点击确认登录，请求发送到后端服务器后会做以下操作：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8、IM-发送推送，将上一步获得的-认证key-交给前端，前端使用此key继续与后端进行登录的操作"><span class="nav-number">2.0.6.</span> <span class="nav-text">8、IM 发送推送，将上一步获得的 认证key 交给前端，前端使用此key继续与后端进行登录的操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">2.1.</span> <span class="nav-text">总结</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#长连接"><span class="nav-number">3.</span> <span class="nav-text">长连接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">3.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-长连接"><span class="nav-number">3.2.</span> <span class="nav-text">HTTP 长连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-0-和-1-1-的区别"><span class="nav-number">3.2.1.</span> <span class="nav-text">1.0 和 1.1 的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP-的长连接、短连接"><span class="nav-number">3.3.</span> <span class="nav-text">TCP 的长连接、短连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-短连接"><span class="nav-number">3.3.1.</span> <span class="nav-text">TCP 短连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-长连接"><span class="nav-number">3.3.2.</span> <span class="nav-text">TCP 长连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#利弊分析"><span class="nav-number">3.3.3.</span> <span class="nav-text">利弊分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#长连接的优缺点"><span class="nav-number">3.3.3.1.</span> <span class="nav-text">长连接的优缺点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#短连接的优缺点"><span class="nav-number">3.3.3.2.</span> <span class="nav-text">短连接的优缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么时候该用长连接或是短连接"><span class="nav-number">3.3.4.</span> <span class="nav-text">什么时候该用长连接或是短连接</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WebSocket"><span class="nav-number">4.</span> <span class="nav-text">WebSocket</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#先看一个栗子"><span class="nav-number">4.1.</span> <span class="nav-text">先看一个栗子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Request-Header"><span class="nav-number">4.1.1.</span> <span class="nav-text">Request Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Response-Header"><span class="nav-number">4.1.2.</span> <span class="nav-text">Response Header</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebSocket-和-HTTP-的关系"><span class="nav-number">4.2.</span> <span class="nav-text">WebSocket 和 HTTP 的关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HL-瞎BB"><span class="nav-number">4.2.1.</span> <span class="nav-text">HL 瞎BB</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebSocket-借助-HTTP-请求来建立连接"><span class="nav-number">4.3.</span> <span class="nav-text">WebSocket 借助 HTTP 请求来建立连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类似WebSocket-的及时通讯技术"><span class="nav-number">4.4.</span> <span class="nav-text">类似WebSocket 的及时通讯技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前端轮询"><span class="nav-number">4.4.1.</span> <span class="nav-text">前端轮询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Comet-技术"><span class="nav-number">4.4.2.</span> <span class="nav-text">Comet 技术</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三种方式的比较"><span class="nav-number">4.5.</span> <span class="nav-text">三种方式的比较</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主动性"><span class="nav-number">4.5.1.</span> <span class="nav-text">主动性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实时性"><span class="nav-number">4.5.2.</span> <span class="nav-text">实时性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优劣比较"><span class="nav-number">4.5.3.</span> <span class="nav-text">优劣比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结-1"><span class="nav-number">4.6.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ref"><span class="nav-number">5.</span> <span class="nav-text">Ref</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#随笔"><span class="nav-number">6.</span> <span class="nav-text">随笔</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <div id="aplayer" class="aplayer" data-id="2228455822" data-server="netease" data-type="playlist" data-mode="random"></div>

    <footer id="footer" class="footer">
      <div class="footer-image"></div>
      <div class="footer-inner">
        <p>博客已萌萌哒运行<span id="since"></span><span class="my-face">(●'◡'●)ﾉ♥</span></p>
<p></p>

<p>© <span itemprop="copyrightYear">2019</span> 合缘奇缘，一期一念.
    Powered By <a href="https://hexo.io/" target="_blank" class="external" rel="nofollow">Hexo</a>.
    Theme By <a href="https://github.com/DIYgod/hexo-theme-sagiri" target="_blank" class="external" rel="nofollow">Sagiri</a>.
    Made with ♥ by <a href="https://github.com/lanc4r" target="_blank"><span class="author" itemprop="copyrightHolder">Lanc4r</span></a>. 
</p>
<p><span id="busuanzi_container_site_pv">(/ω＼*)……… (/ω•＼*) 目前共有 <span id="busuanzi_value_site_uv"></span> 位来访者 ♥ 共计浏览次数 <span id="busuanzi_value_site_pv"></span> 次 (/▽＼)</span></p>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    


    <canvas id="evanyou"></canvas>
    <canvas id="live2d" width="150" height="400" class="live2d"></canvas>

    

  </div>

  <script type="text/javascript" src="/js/sagiri.min.js?v=0.0.4"></script>

  





  

  
  

  

  

  


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/love.js"></script>

  <!-- 头像的 animated 效果 -->
  <script type="text/javascript" src="/js/animated.js"></script>

  <!-- 站内搜索 search 文件，以及搜索按钮初始化代码 -->
  <script type="text/javascript" src="/js/search.js"></script>
  <script type="text/javascript" id="local.search.active">
    window.onload = function (){
      var inputArea       = document.querySelector("#local-search-input");
      inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
      inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
    }
  </script>

  <!-- aplayer 播放器 -->
  <script type="text/javascript" src="/js/Meting.min.js"></script>

  <!-- 点击变为少女祈祷中 -->
  <script type="text/javascript">
    $(document).ready(function (){
       $(".post-title-link").click(function (){
           $(this).text("少女祈祷中……");
       });
    });
  </script>

  <!-- 不蒜子 计数器 -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <!-- 输入框输入内容 屏幕抖动效果 
  <script type="text/javascript" src="/js/activate-power-mode.js"></script>
  <script type="text/javascript">
    // 由于 livere 不是访问页面时候就加载，所以需要写一个监听函数，判断当其DOM结构发生变化时再进行设置
    //$("#comments").bind('DOMNodeInserted', function (e){
    POWERMODE.colorful = 'true';    // make power mode colorful
    POWERMODE.shake = 'false';       // turn off shake
    // TODO 这里根据具体情况修改
    document.body.addEventListener('input', POWERMODE);
    //});
  </script>-->

</body>
</html>
